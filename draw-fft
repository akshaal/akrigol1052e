#!/usr/bin/env python
# Copyright (c) 2017, Akshaal blahblahblah, GNU GPL blahblahblah

import akrigol
import scipy.signal
import numpy as np
import matplotlib.pyplot as plt
import peakdetect

# Read previously serialized 'scope' object
#scp = akrigol.deserialize("scope")
#ch = scp.active_channels[0]

#points = ch.raw_points
#sample_rate = ch.sample_rate

# Y = np.fft.rfft(points)
# Y = np.abs(Y)
#

#

t = np.linspace(0, 2*np.pi, 5000000, endpoint=True)
f = 50.0 # Frequency in Hz
A = 100.0 # Amplitude in Unit
s = A * np.sin(2*np.pi*f*t) # Signal
sample_rate = 1 / (t[1] - t[0])

print("Sample rate: " + str(sample_rate))

Y = np.fft.rfft(s)
N = len(Y)
Y = np.abs(Y)
Y = 2 * Y / N
Y = 20 * np.log10(Y)

X = np.linspace(0, sample_rate / 2.0, N, endpoint = True)

peaks, peaks2 = peakdetect.peakdetect(np.array(Y), lookahead = 2, delta = 2)

plt.plot(X, Y)
plt.xlabel('Frequency ($Hz$)')
plt.ylabel('Amplitude [dB]')

for peak in peaks:
    peak = peak[0]
    print("Peak at " + akrigol.as_hz(X[peak]) + " of " + akrigol.as_wtf((Y[peak])))
    plt.text(X[peak], Y[peak], akrigol.as_wtf(X[peak]))

plt.savefig("out/x.png", dpi = 150)
